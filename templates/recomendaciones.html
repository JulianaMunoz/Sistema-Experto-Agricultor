<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Recomendaciones</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/home">üåæ Sistema Experto</a>
    </div>
  </nav>

  <main class="container py-4">
    <h2>Recomendaciones</h2>
    <p class="text-muted">Responde las preguntas y el sistema recomendar√° cultivos seg√∫n las reglas.</p>

    <div id="wizard" class="card p-4">
      <div id="pregunta" class="mb-3"></div>
      <div id="opciones" class="mb-3"></div>
      <div class="d-flex gap-2">
        <button id="btnBack" class="btn btn-outline-secondary">Atr√°s</button>
        <button id="btnNext" class="btn btn-success ms-auto">Siguiente</button>
        <button id="btnConsultar" class="btn btn-primary d-none">Consultar</button>
      </div>
    </div>

    <div id="resultado" class="mt-4 d-none card p-3"></div>
  </main>

  <script>
window.addEventListener('DOMContentLoaded', async () => {
  // Consultar preguntas desde la API
  let todosPreguntas = {};
  try {
    const resp = await fetch('/api/preguntas');
    if (!resp.ok) throw new Error('No se pudieron cargar las preguntas');
    const data = await resp.json(); // [{id,text,options:[{v,t}]}]
    data.forEach(q => { todosPreguntas[q.id] = q; });
  } catch (e) {
    console.error('API preguntas error:', e);
    // fallback m√≠nimo para que siga funcionando
    todosPreguntas = {
      altitud: { id:'altitud', text:'¬øCu√°l es la altitud de la parcela?', options:[
        {v:'<=1000',t:'‚â§ 1.000 msnm'},{v:'1000-2000',t:'1.000 - 2.000 msnm'},{v:'2000-3000',t:'2.000 - 3.000 msnm'},{v:'>=3000',t:'‚â• 3.000 msnm'}
      ]},
      clima: { id:'clima', text:'¬øC√≥mo describes el clima?', options:[] },
      suelo: { id:'suelo', text:'¬øCu√°l es el tipo de suelo?', options:[] },
      riego: { id:'riego', text:'¬øCuentas con riego?', options:[{v:'si',t:'S√≠'},{v:'no',t:'No'}] },
      riesgo_heladas: { id:'riesgo_heladas', text:'¬øExiste riesgo de heladas?', options:[{v:'si',t:'S√≠'},{v:'no',t:'No'}] },
      manejo_heladas: { id:'manejo_heladas', text:'¬øCuentas con manejo de heladas?', options:[{v:'si',t:'S√≠'},{v:'no',t:'No'}] },
      zona: { id:'zona', text:'¬øEs zona de conservaci√≥n ambiental?', options:[{v:'si',t:'S√≠'},{v:'no',t:'No'}] }
    };
  }

  // Reusar la l√≥gica de wizard existente pero usando todosPreguntas din√°mico
  const preguntaEl = document.getElementById("pregunta");
  const opcionesEl = document.getElementById("opciones");
  const btnNext = document.getElementById("btnNext");
  const btnBack = document.getElementById("btnBack");
  const btnConsultar = document.getElementById("btnConsultar");
  const resultadoEl = document.getElementById("resultado");

  let preguntaActual = null;
  let respuestas = {};

  function construirOpcionesClima(altitud) {
    // Mapeo basado en reglas del enunciado
    const opcionesClima = {
      '<=1000': ['h√∫medo', 'seco'],
      '1000-2000': ['h√∫medo', 'seco'],
      '2000-3000': ['estable'],
      '>=3000': ['muy_fr√≠o_h√∫medo']
    };
    const vals = opcionesClima[altitud] || [];
    return (todosPreguntas.clima?.options || []).filter(o => vals.includes(o.v)).map(o => ({v:o.v,t:o.t}));
  }

  function construirOpcionesSuelo(clima) {
    const opcionesSuelo = {
      'h√∫medo': ['arcilloso', 'franco', 'arenoso'],
      'seco': [],
      'estable': ['franco', 'arcilloso']
    };
    const vals = opcionesSuelo[clima] || [];
    return (todosPreguntas.suelo?.options || []).filter(o => vals.includes(o.v)).map(o => ({v:o.v,t:o.t}));
  }

  function renderPregunta(preguntaId) {
    let p = todosPreguntas[preguntaId];
    if (!p) {
      preguntaEl.innerHTML = "<strong>Error</strong>";
      opcionesEl.innerHTML = "<p>Pregunta no encontrada.</p>";
      return;
    }

    if (preguntaId === 'clima') {
      const alt = respuestas['altitud'];
      p = { ...p, options: construirOpcionesClima(alt) };
    } else if (preguntaId === 'suelo') {
      const clim = respuestas['clima'];
      p = { ...p, options: construirOpcionesSuelo(clim) };
    }

    preguntaActual = p;
    preguntaEl.textContent = p.text;
    opcionesEl.innerHTML = "";

    if (!p.options || p.options.length === 0) {
      opcionesEl.innerHTML = "<div class='text-muted'>No hay opciones disponibles para esta pregunta.</div>";
      btnNext.disabled = true;
      return;
    }

    p.options.forEach(o => {
      const id = `opt-${p.id}-${o.v}`;
      const wrapper = document.createElement("div");
      wrapper.className = "form-check";
      wrapper.innerHTML = `
        <input class="form-check-input" type="radio" name="${p.id}" id="${id}" value="${o.v}">
        <label class="form-check-label" for="${id}">${o.t}</label>
      `;
      opcionesEl.appendChild(wrapper);
    });

    const sel = respuestas[p.id];
    if (sel) {
      const input = opcionesEl.querySelector(`input[value="${sel}"]`);
      if (input) input.checked = true;
    }

    btnNext.classList.remove("d-none");
    btnConsultar.classList.add("d-none");
    btnBack.disabled = Object.keys(respuestas).length === 0;
    resultadoEl.classList.add("d-none");
  }

  function determinarSiguiente() {
    const alt = respuestas['altitud'];
    const clim = respuestas['clima'];
    const suelo = respuestas['suelo'];
    const riego = respuestas['riego'];
    const riesgo = respuestas['riesgo_heladas'];
    const manejo = respuestas['manejo_heladas'];

    if (!alt) return 'altitud';
    if (!clim) return 'clima';

    // reglas indicadas por el usuario (piso t√©rmico / condiciones)
    if (alt === '<=1000' || alt === '1000-2000') {
      if (clim === 'h√∫medo') {
        if (!suelo) return 'suelo';
      } else if (clim === 'seco') {
        if (!riego) return 'riego';
      }
    } else if (alt === '2000-3000') {
      if (clim === 'estable') {
        if (!suelo) return 'suelo';
      }
    } else if (alt === '>=3000') {
      // en p√°ramo no requiere m√°s preguntas salvo zona
      if (!respuestas['zona']) return 'zona';
    }

    return null;
  }

  document.getElementById("btnNext").addEventListener("click", () => {
    if (!preguntaActual) return;
    const sel = opcionesEl.querySelector(`input[name="${preguntaActual.id}"]:checked`);
    if (!sel) { alert("Seleccione una opci√≥n para continuar."); return; }

    respuestas[preguntaActual.id] = sel.value;
    const siguiente = determinarSiguiente();

    if (siguiente) {
      renderPregunta(siguiente);
    } else {
      preguntaEl.innerHTML = "<strong>‚úÖ Listo</strong>";
      opcionesEl.innerHTML = "<p>Ahora puedes consultar las recomendaciones de cultivos seg√∫n tus respuestas.</p>";
      btnNext.classList.add("d-none");
      btnConsultar.classList.remove("d-none");
    }
  });

  document.getElementById("btnBack").addEventListener("click", () => {
    const keys = Object.keys(respuestas);
    if (keys.length > 0) {
      const lastKey = keys[keys.length - 1];
      delete respuestas[lastKey];
      const siguiente = determinarSiguiente();
      renderPregunta(siguiente || 'altitud');
    }
  });

  document.getElementById("btnConsultar").addEventListener("click", async () => {
    btnConsultar.disabled = true;
    btnConsultar.textContent = "Consultando‚Ä¶";
    try {
      const resp = await fetch("/api/recomendar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(respuestas)
      });
      const data = await resp.json();
      resultadoEl.classList.remove("d-none");

      if (data && data.count > 0 && Array.isArray(data.recomendaciones)) {
        resultadoEl.innerHTML = `<h4>‚úÖ Recomendaciones (${data.count}):</h4><ul class="list-group">`;
        data.recomendaciones.forEach(rec => {
          resultadoEl.innerHTML += `<li class="list-group-item"><strong>${rec}</strong></li>`;
        });
        resultadoEl.innerHTML += `</ul>`;
      } else {
        resultadoEl.innerHTML = `<div class="alert alert-warning">‚ùå No se encontraron recomendaciones para tus respuestas.</div>`;
      }
    } catch (e) {
      console.error('Error:', e);
      resultadoEl.classList.remove("d-none");
      resultadoEl.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
    } finally {
      btnConsultar.disabled = false;
      btnConsultar.textContent = "Consultar";
    }
  });

  // iniciar por altitud
  renderPregunta('altitud');
});
</script>
</body>
</html>