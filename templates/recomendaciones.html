<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" type="image/png" href="../static/assests/favicon.png">
  <title>Agro-Expert</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/home">üåæ Sistema Experto</a>
    </div>
  </nav>

  <main class="container py-4">
    <h2>Recomendaciones</h2>
    <p class="text-muted">Responde las preguntas y el sistema recomendar√° cultivos seg√∫n las reglas.</p>

    <div id="wizard" class="card p-4">
      <div id="pregunta" class="mb-3"></div>
      <div id="opciones" class="mb-3"></div>
      <div class="d-flex gap-2">
        <button id="btnBack" class="btn btn-outline-secondary">Atr√°s</button>
        <button id="btnNext" class="btn btn-success ms-auto">Siguiente</button>
        <button id="btnConsultar" class="btn btn-primary d-none">Consultar</button>
      </div>
    </div>

    <div id="resultado" class="mt-4 d-none card p-3"></div>
  </main>

  <script>
window.addEventListener('DOMContentLoaded', async () => {
  const preguntaEl = document.getElementById("pregunta");
  const opcionesEl = document.getElementById("opciones");
  const btnNext = document.getElementById("btnNext");
  const btnBack = document.getElementById("btnBack");
  const btnConsultar = document.getElementById("btnConsultar");
  const resultadoEl = document.getElementById("resultado");

  let respuestas = {};
  let historial = [];
  let preguntaActual = null;

  function renderPregunta(pregunta) {
    preguntaActual = pregunta;
    resultadoEl.classList.add("d-none");

    if (!pregunta) {
      preguntaEl.innerHTML = "<strong>Listo</strong>";
      opcionesEl.innerHTML = "<p>Ya puedes consultar las recomendaciones segun tus respuestas.</p>";
      btnNext.classList.add("d-none");
      btnConsultar.classList.remove("d-none");
      btnBack.disabled = historial.length === 0;
      return;
    }

    preguntaEl.textContent = pregunta.text || pregunta.id;
    opcionesEl.innerHTML = "";
    if (!pregunta.options || !pregunta.options.length) {
      opcionesEl.innerHTML = "<div class='text-muted'>No hay opciones disponibles para esta pregunta.</div>";
      btnNext.disabled = true;
      return;
    }

    btnNext.disabled = false;
    pregunta.options.forEach((opcion) => {
      const inputId = ("opt-" + pregunta.id + "-" + opcion.v).replace(/[^a-zA-Z0-9_-]/g, "");
      const wrapper = document.createElement("div");
      wrapper.className = "form-check";
      wrapper.innerHTML =
        '<input class="form-check-input" type="radio" name="' + pregunta.id + '" id="' + inputId + '" value="' + opcion.v + '">' +
        '<label class="form-check-label" for="' + inputId + '">' + opcion.t + "</label>";
      opcionesEl.appendChild(wrapper);
    });

    const seleccion = respuestas[pregunta.id];
    if (seleccion) {
      const input = opcionesEl.querySelector('input[value="' + seleccion + '"]');
      if (input) input.checked = true;
    }

    btnNext.classList.remove("d-none");
    btnConsultar.classList.add("d-none");
    btnBack.disabled = historial.length === 0 && !respuestas[pregunta.id];
  }

  async function cargarSiguientePregunta() {
    try {
      const resp = await fetch("/api/pregunta-siguiente", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(respuestas)
      });
      if (!resp.ok) throw new Error("No se pudieron obtener preguntas");
      const data = await resp.json();
      renderPregunta(data.pregunta);
    } catch (err) {
      console.error("API pregunta-siguiente error:", err);
      preguntaEl.innerHTML = "<strong>No se pudieron cargar las preguntas.</strong>";
      opcionesEl.innerHTML = "<p class='text-muted'>Revisa la conexi√≥n o los datos de la base.</p>";
      btnNext.classList.add("d-none");
      btnConsultar.classList.add("d-none");
      btnBack.disabled = historial.length === 0;
    }
  }

  await cargarSiguientePregunta();

  btnNext.addEventListener("click", async () => {
    if (!preguntaActual) {
      await cargarSiguientePregunta();
      return;
    }
    const seleccion = opcionesEl.querySelector('input[name="' + preguntaActual.id + '"]:checked');
    if (!seleccion) {
      alert("Selecciona una opcion para continuar.");
      return;
    }
    respuestas[preguntaActual.id] = seleccion.value;
    historial = historial.filter((k) => k !== preguntaActual.id);
    historial.push(preguntaActual.id);
    await cargarSiguientePregunta();
  });

  btnBack.addEventListener("click", async () => {
    if (!historial.length) return;
    const last = historial.pop();
    delete respuestas[last];
    await cargarSiguientePregunta();
  });

  btnConsultar.addEventListener("click", async () => {
    btnConsultar.disabled = true;
    btnConsultar.textContent = "Consultando...";
    try {
      const resp = await fetch("/api/recomendar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(respuestas)
      });
      if (!resp.ok) throw new Error("No se pudieron obtener recomendaciones");
      const data = await resp.json();
      resultadoEl.classList.remove("d-none");
      if (Array.isArray(data.recomendaciones) && data.recomendaciones.length > 0) {
        let total = data.count || data.recomendaciones.length;
        let html = '<h4>Recomendaciones (' + total + ')</h4><div class="list-group">';
        data.recomendaciones.forEach((rec) => {
          html += '<div class="list-group-item d-flex justify-content-between align-items-center">' +
            '<strong>' + rec.descripcion + '</strong>' +
            '<span class="badge bg-success">' + rec.porcentaje + '%</span>' +
            '</div>';
        });
        html += "</div>";
        resultadoEl.innerHTML = html;
      } else {
        const mensaje = data.message || "No se encontraron recomendaciones para tus respuestas.";
        resultadoEl.innerHTML = '<div class="alert alert-warning">' + mensaje + "</div>";
      }
    } catch (err) {
      console.error("Error recomendaciones:", err);
      resultadoEl.classList.remove("d-none");
      resultadoEl.innerHTML = '<div class="alert alert-danger">' + err.message + "</div>";
    } finally {
      btnConsultar.disabled = false;
      btnConsultar.textContent = "Consultar";
    }
  });
});
</script>
</body>
</html>
